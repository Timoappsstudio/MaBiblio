<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MaBiblio</title>
    
    <link rel="apple-touch-icon" href="https://via.placeholder.com/180x180.png?text=MB">
    <link rel="apple-touch-icon" sizes="152x152" href="https://via.placeholder.com/152x152.png?text=MB">
    <link rel="apple-touch-icon" sizes="180x180" href="https://via.placeholder.com/180x180.png?text=MB">
    <link rel="apple-touch-icon" sizes="167x167" href="https://via.placeholder.com/167x167.png?text=MB">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* FIX RECTANGLE GRIS AU DEMARRAGE */
        :root { --ios-bg: #F2F2F7; }
        html, body { 
            background-color: #000000; /* Fond noir par défaut pour éviter le flash gris/blanc */
            margin: 0; 
            padding: 0; 
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        #auth-screen { 
            background-color: var(--ios-bg); /* L'écran de connexion redevient gris clair iOS */
            display: none; /* Caché par défaut, affiché par JS */
        }

        .app-shell { 
            background-color: var(--ios-bg);
            height: 100%; 
            display: none; 
            flex-direction: column; 
            padding-top: env(safe-area-inset-top); 
        }

        /* Styles restants (inchangés) */
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700;800;900&display=swap');
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; color: #1C1C1E; -webkit-tap-highlight-color: transparent; }
        header { padding: 20px 20px 10px; background: var(--ios-bg); }
        .header-title { font-size: 34px; font-weight: 800; letter-spacing: -0.5px; }
        .type-tabs { display: flex; gap: 20px; margin-top: 15px; }
        .type-tab { font-size: 17px; font-weight: 700; color: #8E8E93; padding-bottom: 8px; border-bottom: 3px solid transparent; cursor: pointer; }
        .type-tab.active { color: #000; border-color: #000; }
        .status-pills { display: flex; gap: 8px; padding: 12px 0; overflow-x: auto; scrollbar-width: none; }
        .pill { padding: 8px 16px; border-radius: 18px; font-size: 14px; font-weight: 700; background: #E5E5EA; white-space: nowrap; }
        .pill.active { background: #000; color: white; }
        .scroll-area { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 120px; }
        .year-divider { padding: 24px 16px 8px; font-size: 20px; font-weight: 900; color: #000; background: var(--ios-bg); position: sticky; top: -1px; z-index: 10; }
        .items-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 0 16px 24px; }
        .grid-item { aspect-ratio: 2/3; background: #DDD; border-radius: 12px; overflow: hidden; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .grid-item-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 8px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; }
        .grid-rating { position: absolute; top: 6px; right: 6px; background: #FF9500; padding: 2px 6px; border-radius: 6px; font-size: 11px; font-weight: 900; color: white; }
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: calc(75px + env(safe-area-inset-bottom)); background: rgba(255,255,255,0.92); backdrop-filter: blur(20px); border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; justify-content: space-around; align-items: flex-start; padding-top: 12px; z-index: 50; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; color: #A2A2A7; font-size: 11px; font-weight: 600; flex: 1; }
        .nav-btn i { font-size: 24px; margin-bottom: 4px; }
        .nav-btn.active { color: #007AFF; }
        .nav-plus { width: 52px; height: 52px; background: #007AFF; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-top: -16px; box-shadow: 0 6px 16px rgba(0, 122, 255, 0.45); }
        .modal { position: fixed; inset: 0; background: var(--ios-bg); z-index: 100; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .modal.open { transform: translateY(0); }
        #preview-modal { background: #111; color: white; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDo4sqS3BIW1DmNxWA1IJtlD9GRFs4rd_g",
            authDomain: "mabiblio-dc595.firebaseapp.com",
            projectId: "mabiblio-dc595",
            storageBucket: "mabiblio-dc595.firebasestorage.app",
            messagingSenderId: "683284434520",
            appId: "1:683284434520:web:0c72c547703843781f442d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'mabiblio-dc595';

        // État Global
        window.currentUser = null;
        window.currentView = 'home';
        window.currentType = 'Film'; 
        window.currentStatus = 'Vu'; 

        // Gestion Authentification
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.querySelector('.app-shell').style.display = 'flex';
                loadUserData();
            } else {
                window.currentUser = null;
                document.getElementById('auth-screen').style.display = 'flex';
                document.querySelector('.app-shell').style.display = 'none';
            }
        });

        // Correction Suppression : On vide l'aperçu et on rafraîchit
        window.deleteItem = async (docId) => {
            if (!confirm("Supprimer cet élément ?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'items', docId));
                window.closePreview();
                // Le onSnapshot s'occupe de rafraîchir la liste automatiquement
            } catch (e) { console.error(e); }
        };

        // ... Reste des fonctions JS (window.saveItem, etc. à garder identiques à ta version précédente)
    </script>
</head>
<body>

    <div id="auth-screen" class="fixed inset-0 z-[9999] flex items-center justify-center p-6">
        <div class="w-full max-w-sm bg-white p-8 rounded-[30px] shadow-xl">
             <h1 class="text-3xl font-black text-center mb-6">MaBiblio</h1>
             <input type="email" id="auth-email" placeholder="Email" class="w-full p-4 bg-gray-100 rounded-2xl mb-3 outline-none">
             <input type="password" id="auth-password" placeholder="Mot de passe" class="w-full p-4 bg-gray-100 rounded-2xl mb-6 outline-none">
             <button onclick="handleAuth()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold">Se connecter</button>
        </div>
    </div>

    <div class="app-shell">
        <header id="app-header">
            <div class="header-title">Ma Biblio</div>
            </header>
        <div class="scroll-area" id="main-content"></div>
        </div>

</body>
</html>
